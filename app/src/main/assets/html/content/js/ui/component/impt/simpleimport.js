/*!
 * simple import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,i){"use strict";if(e&&"undefined"==typeof e.Import){var l=(Array.prototype.splice,3e3),r=function(t,l){var r=this;r.el=t&&1==t.nodeType?t:i.getElementById(t),r.el&&r.el.nodeType&&(r.id=e.attr(r.el,"id"))&&(l&&e.isObject(l)&&e.extend(r,l),e.attr(r.el,"x-wade-uicomponent")||e.attr(r.el,"x-wade-uicomponent","simpleimport"),r._init(),r.constructor.call(r))};r.prototype=e.extend(new e.UIComponent,{setParams:function(t){var i=this;t&&e.isString(t)&&(i.params=t)},buildParams:function(t){var i=this,l=[];return l.push("rpcSessionId="+i.rpcSessionId),l.push("pushMode="+i.pushMode),l.push("config="+(i.configFile?i.configFile:"")),l.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),l.push("filePath="+(i.filePath?i.filePath:"import")),l.push("fileId="+(i.file?i.file.fileId:"")),l.push("fileName="+(i.file?encodeURIComponent(i.file.name):"")),l.push("fileType="+(i.fileType?i.fileType:"")),l.push("model="+(i.model?i.model:"")),l.push("posX="+(i.posX?i.posX:"")),l.push("posY="+(i.posY?i.posY:"")),l.push("txtSplit="+(i.txtSplit?i.txtSplit:"")),l.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),l.push("taskId="+(i.taskId?i.taskId:"")),l.push("serviceName="+(i.taskId?i.taskId:"")),l.push("listenerMethod="+(t?t:"")),e.ajax.buildSubmitData(i.cond,l.join("&")+(i.params&&e.isString(i.params)?"&"+i.params:""))},tip:function(e,t){var i=this;void 0!=e&&(i.nameEl.value=e),void 0!=t&&(i.nameEl.className=t)},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(t){var i=this;i.disabled=!!t;var l=i.span.className?i.span.className:"";i.disabled?((" "+l+" ").indexOf(" e_dis ")<0&&(i.span.className=e.trim(l+" e_dis")),i.nameEl.disabled=!0):(l=e.trim((" "+l+" ").replace(/ e_dis /gi," ")),i.span.className=l,i.nameEl.disabled=!1)},destroy:function(){var e=this;if(e.rpc&&(e.rpc.destroy(),e.rpc=null),e.file){for(var t in e.file)delete e.file[t];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.span=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.btnDownload=null,e.btnBrowser=null,e.btnImport=null,e.progEl=null,e.progBarEl=null,e.el=null,e.defaultTip=null},_init:function(){var t=this;t.url=e.FILE_UPLOAD_URL+(t.ftpCode?"&ftpSite="+t.ftpCode:"")+(t.filePath?"&filePath="+t.filePath:""),t.span=e(t.el).parent("span.e_mix:first")[0],t.nameEl=e(t.span).children("input[type=text]:first")[0],t.fileFormEl=e(t.span).children("form:first")[0],t.fileEl=e(t.fileFormEl).children("input:first")[0],t.btnDownload=e(t.span).children("span.e_ico-download:first")[0],t.btnBrowser=e(t.span).children("span.e_ico-browse:first")[0],t.btnImport=e(t.span).find("span.e_ico-import:first").parent("button:first")[0],t.progEl=e(t.span).children("span.e_mixProgress:first")[0],t.progBarEl=e(t.progEl).children("span.e_mixBar:first")[0];var i=e.attr(t.nameEl,"id");i||(i=t.id+"_name",e.attr(t.nameEl,"id",i)),e.attr(t.el,"x-visible-element",i),t.templateFile&&e.isString(t.templateFile)&&(t.btnDownload.style.display="",e.attr(t.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.tpldownload"))),t.fileTypes&&(t.fileTypes=e.FileTransfer.fileTypes(t.fileTypes),t.fileTypes&&e.attr(t.fileEl,"accept",e.FileTransfer.mimeType(t.fileTypes))),t.fileTypeTip=t.fileTypes&&t.fileTypes.length?e.lang.get("ui.component.simpleimport.tip.support-filetypes",t.fileTypes.join(",")):"",t.fileTypeTip&&e.attr(t.btnBrowser,"tip",t.fileTypeTip),t.rpcSessionId=e.expando+"_"+e.rand(1e6)+"_"+t.id,t.useSwfUpload=e.browser.msie&&e.browser.version<10,1==t.useSwfUpload?(e(t.btnBrowser).append('<span id="'+t.id+'_swfupload_holder"></span>'),t.swfup=new SWFUpload({upload_url:t.url,file_size_limit:t.fileSize,file_types:t.fileTypes&&t.fileTypes.length?(""+t.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:t.id+"_swfupload_holder",button_width:t.btnBrowser.offsetWidth,button_height:t.btnBrowser.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(i){if(t.auto&&!1===e.event.trigger("beforeAction",null,t.el))for(var l=this.getStats();l.files_queued>0;)this.cancelUpload(null,!1),l=this.getStats();else t._setFile(i),this.startUpload()},file_queue_error_handler:function(i,l,r){switch(l){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(e.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(e.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(e.lang.get("ui.component.upload.tip.file-num-limit",t.fileLimit))}},upload_start_handler:function(e){t._transferStart(t.file)},upload_progress_handler:function(e,i,l){t._transferProgress(i,l,t.file)},upload_success_handler:function(i,l){t._transferSuccess(e.parseJSON(l),"suc",t.file)},upload_error_handler:function(e,i,l){t._transferError(i,l,t.file)}})):t.transfer=new e.FileTransfer({context:t,url:t.url,start:t._transferStart,success:t._transferSuccess,error:t._transferError,progress:function(e,i){t._transferProgress(e.loaded,e.total,i)}}),e(t.btnDownload).tap(function(){t.disabled||!0===t.uploading||!0===t.importing||(t.downUrl?e.FileTransfer.download(t.downUrl+"&_="+Math.random()):t.templateFile&&e.FileTransfer.download(t.templateFile))}),e(t.btnBrowser).tap(function(){if(!t.disabled&&!0!==t.uploading&&!0!==t.importing){if(t.useSwfUpload){var i=swfobject.getFlashPlayerVersion();return void(i&&i.major||alert(e.lang.get("ui.component.swfobject.tip.flashplayer-not-installed")))}t.fileEl.click()}}),e(t.fileEl).bind("change",function(){if(!t.disabled&&!0!==t.uploading&&!0!==t.importing){if(t.auto&&!1===e.event.trigger("beforeAction",null,t.el))return void(t.fileFormEl&&t.fileFormEl.nodeType&&t.fileFormEl.reset());if(!(t.fileEl.files.length<=0)){var i=t.fileEl.files[0];t._setFile(i),t.file&&!t.useSwfUpload&&(t.downUrl&&(t.downUrl=null,e.attr(t.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.tpldownload"))),t.transfer.file=t.file,t.transfer.send(),t.uploading=!0)}}}),t.auto||e(t.btnImport).tap(function(){t.disabled||!0===t.uploading||!0===t.importing||!1!==e.event.trigger("beforeAction",null,t.el)&&t._doImport()})},_setFile:function(t){var i=this,l=t.name,r=t.size,n=!0;return i._validateFileType(l)?n&&r>i.fileSize?(n=!1,void i.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(i.file={name:l,size:r,valid:n,fileObject:t}):(n=!1,void i.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(t){var i=this;if(!i.fileTypes||!i.fileTypes.length)return!0;var l=e.FileTransfer.extName(t);return l&&e.isString(l)&&e.inArray(l,i.fileTypes)>-1||void 0==l},_transferStart:function(e){var t=this;t.progBarEl.style.width="0%",t.tip(e.name,"e_black-light")},_transferSuccess:function(e,t,i){var l,r,n=this,o=-1;return e&&e.context&&e.data&&(r=e.data.fileId)?(n.uploading=!1,i.fileId=n.el.value=r,i.fileObject=null,n.fileFormEl&&n.fileFormEl.nodeType&&n.fileFormEl.reset(),n.progBarEl.style.width="0%",n.tip(i.name),void(n.auto?n._doImport():n.btnImport.style.display="")):(o=e&&e.context?e.context.x_resultcode:"-1",l=e&&e.context?e.context.x_resultinfo:"",void n._transferError.call(n,o,l,i))},_transferError:function(t,i,l){var r=this;r.uploading=!1,l.fileObject=null,r.fileFormEl&&r.fileFormEl.reset(),r.tip(e.lang.get("ui.component.simpleimport.tip.upload-faild-info",i?i:"Status("+t+")"),"e_red")},_transferProgress:function(t,i,l){var r=this,n=t>0&&i>0?Math.round(t/i*100):0;n>=100&&(n=99),r.progBarEl.style.width=n+"%",r.tip(e.lang.get("ui.component.simpleimport.tip.uploading",n,l.name))},_doImport:function(){var i=this;i.fileSerializeId=null,i.tip(e.lang.get("ui.component.simpleimport.tip.begin-import",i.file.name)),e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(r){if(i.fileSerializeId=r.fileSerializeId,i.messageServer=r.messageServer,i.messageServerType=r.messageServerType?r.messageServerType:null,!0===i.importing)if("10"==r.progress)i.tip(e.lang.get("ui.component.simpleimport.tip.import-started"));else{if(!i.fileSerializeId&&"error"==r.status)return i.importing=!1,i.progBarEl.style.width="0%",void i.tip(r.hint,"e_red");i.progBarEl.style.width=r.progress+"%",i.tip(e.lang.get("ui.component.simpleimport.tip.importing",r.progress+"%",i.file.name))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new e.RPC({address:i.messageServer,type:i.messageServerType,session:"&sessionId="+i.rpcSessionId,message:function(t){if(t&&e.isObject(t)){if(i.importing=!1,i.btnImport.style.display="none","ok"==t.STATUS){i.progBarEl.style.width="100%";var l=t.ERROR_INFO,r=i.downUrl=t.DOWNLOAD_URL;r&&e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.faild-data-download"));var n=e.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(l)){var o=l.split(",");n+=" "+e.lang.get("ui.component.simpleimport.tip.import-count",o[0],o[1])}else n=l;i.tip(n,"e_black-light")}else"error"==t.STATUS&&(i.progBarEl.style.width="0%",i.tip(t.ERROR_INFO,"e_red"));e.event.trigger("afterAction",t.STATUS,i.el)}}}),i.rpc.open()):i.timer=t.setInterval(function(){return i.fileSerializeId?void e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(l){if(!l||!e.isObject(l))return void t.clearInterval(i.timer);if("100"==l.progress||"error"==l.status){if(t.clearInterval(i.timer),i.importing=!1,i.btnImport.style.display="none","ok"==l.status){i.progBarEl.style.width="100%";var r=l.hint,n=i.downUrl=l.downloadUrl;n&&e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.faild-data-download"));var o=e.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(r)){var a=r.split(",");o+=" "+e.lang.get("ui.component.simpleimport.tip.import-count",a[0],a[1])}else o=r;i.tip(o,"e_black-light")}else"error"==l.status&&(i.progBarEl.style.width="0%",i.tip(l.hint,"e_red"));e.event.trigger("afterAction",l.status,i.el)}},error:function(l,r,n){t.clearInterval(i.timer),i.importing=!1,i.tip(e.lang.get("ui.component.simpleimport.tip.import-faild",r),"e_red")}}):void t.clearInterval(i.timer)},l)},error:function(t,l,r){i.importing=!1,i.tip(e.lang.get("ui.component.simpleimport.tip.import-faild",l),"e_red")}}),i.importing=!0}}),t.SimpleImport=e.SimpleImport=r}}(window.Wade,window,document);