/*!
 * simple upload component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,l,i){"use strict";if(e&&"undefined"==typeof e.SimpleUpload){var n=(Array.prototype.splice,function(l,n){var t=this;t.el=l&&1==l.nodeType?l:i.getElementById(l),t.el&&t.el.nodeType&&(t.id=e.attr(t.el,"id"))&&(n&&e.isObject(n)&&e.extend(t,n),e.attr(t.el,"x-wade-uicomponent")||e.attr(t.el,"x-wade-uicomponent","simpleupload"),t._init(),t.constructor.call(t))});n.prototype=e.extend(new e.UIComponent,{tip:function(e,l){var i=this;void 0!=e&&(i.nameEl.value=e),void 0!=l&&(i.nameEl.className=l)},loadFile:function(l){var i=this;l&&e.isString(l)&&i.fileId!=l&&(i.btnClose.style.display="none",i.btnDownload.style.display="none",i.btnBrowser.style.display="none",i.icoLoding.style.display="",i.tip(e.lang.get("ui.component.simpleupload.tip.loading-file"),"e_black-light"),i.loading=!0,e.ajaxRequest({url:e.FILE_QUERY_URL,data:"&fileId="+l+"&_="+Math.random(),dataType:"text",success:function(n,t,a){var o,s=!1;try{o=e.parseJSON(n),o.context&&o.data&&"0"==o.context.x_resultcode||(s=!0)}catch(r){s=!0}if(s)i.tip(e.lang.get("ui.component.simpleupload.tip.load-file-faild"),"e_red"),i.icoLoding.style.display="none",i.btnBrowser.style.display=i.readonly?"none":"";else{var d=!1;for(var p in o.data){var f=o.data[p];f&&(d=!0,i.fileId=p,i.file={fileId:p,name:f.fileName,size:parseInt(f.fileSize),valid:!0},i.el.value=p,i.tip(f.fileName),i.icoLoding.style.display="none",i.btnClose.style.display=i.readonly?"none":"",i.btnDownload.style.display="",i.btnBrowser.style.display=i.readonly?"none":"",i.progBarEl.style.width="0%");break}d||(i.tip(e.lang.get("ui.component.upload.tip.loading-files-notfound",l),"e_black-light"),i.icoLoding.style.display="none",i.btnBrowser.style.display=i.readonly?"none":"")}i.loading=!1},error:function(l,n,t){i.tip(e.lang.get("ui.component.simpleupload.tip.load-file-faild"),"e_red"),i.icoLoding.style.display="none",i.btnBrowser.style.display="",i.loading=!1}}))},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(l){var i=this;i.disabled=!!l;var n=i.spanEl.className?i.spanEl.className:"";i.disabled?((" "+n+" ").indexOf(" e_dis ")<0&&(i.spanEl.className=e.trim(n+" e_dis")),i.nameEl.disabled=!0):(n=e.trim((" "+n+" ").replace(/ e_dis /gi," ")),i.spanEl.className=n,i.nameEl.disabled=!1)},getReadonly:function(){var e=this;return e.readonly},setReadonly:function(e){var l=this;l.readonly=!!e,l.btnClose.style.display=l.btnBrowser.style.display=l.readonly?"none":""},destroy:function(){var e=this;if(e.file){for(var l in e.file)delete e.file[l];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.spanEl=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.icoLoding=null,e.btnClose=null,e.btnDownload=null,e.btnBrowser=null,e.progEl=null,e.progBarEl=null,e.el=null,e.defaultTip=null},_init:function(){var l=this;l.url=e.FILE_UPLOAD_URL+"&needSuffix="+l.needSuffix+(l.ftpCode?"&ftpSite="+l.ftpCode:"")+(l.filePath?"&filePath="+encodeURIComponent(l.filePath):"")+(l.copyToFtpCode?"&copyToFtpSite="+l.copyToFtpCode:"")+(l.copyToFilePath?"&copyToFilePath="+encodeURIComponent(l.copyToFilePath):""),l.spanEl=e(l.el).parent("span.e_mix:first")[0],l.nameEl=e(l.spanEl).children("input[type=text]:first")[0],l.fileFormEl=e(l.spanEl).children("form:first")[0],l.fileEl=e(l.fileFormEl).children("input[type=file]:first")[0],l.icoLoding=e(l.spanEl).children("span.e_ico-loading:first")[0],l.btnClose=e(l.spanEl).children("span.e_ico-close:first")[0],l.btnDownload=e(l.spanEl).children("span.e_ico-download:first")[0],l.btnBrowser=e(l.spanEl).children("span.e_ico-browse:first")[0],l.progEl=e(l.spanEl).children("span.e_mixProgress:first")[0],l.progBarEl=e(l.progEl).children("span.e_mixBar:first")[0];var i=e.attr(l.nameEl,"id");i||(i=l.id+"_name",e.attr(l.nameEl,"id",i),e.attr(l.el,"x-visible-element",i)),l.fileTypes&&(l.fileTypes=e.FileTransfer.fileTypes(l.fileTypes),l.fileTypes&&e.attr(l.fileEl,"accept",e.FileTransfer.mimeType(l.fileTypes))),l.defaultTip=e.lang.get("ui.component.simpleupload.tip.file-size-limit",e.FileTransfer.humanSize(l.fileSize)),l.fileTypes&&(l.defaultTip=e.lang.get("ui.component.simpleupload.tip.file-type-limit",l.fileTypes.join(","))+"ï¼Œ"+l.defaultTip),l.tip(l.defaultTip,"e_black-light"),e.attr(l.btnClose,"tip",e.lang.get("ui.component.simpleupload.tip.re-upload")),e.attr(l.btnDownload,"tip",e.lang.get("ui.component.simpleupload.tip.download-uploaded-file")),e.attr(l.btnBrowser,"tip",l.defaultTip),l.useSwfUpload=e.browser.msie&&e.browser.version<10,1==l.useSwfUpload?(e(l.btnBrowser).append('<span id="'+l.id+'_swfupload_holder"></span>'),l.swfup=new SWFUpload({upload_url:l.url,file_size_limit:l.fileSize,file_types:l.fileTypes&&l.fileTypes.length?(""+l.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:l.id+"_swfupload_holder",button_width:l.btnBrowser.offsetWidth,button_height:l.btnBrowser.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){l._setFile(e),this.startUpload()},file_queue_error_handler:function(i,n,t){switch(n){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(e.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(e.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(e.lang.get("ui.component.upload.tip.file-num-limit",l.fileLimit))}},upload_start_handler:function(e){l._transferStart(l.file)},upload_progress_handler:function(e,i,n){l._transferProgress(i,n,l.file)},upload_success_handler:function(i,n){l._transferSuccess(e.parseJSON(n),"suc",l.file)},upload_error_handler:function(e,i,n){l._transferError(i,n,l.file)}})):l.transfer=new e.FileTransfer({context:l,url:l.url,start:l._transferStart,success:l._transferSuccess,error:l._transferError,progress:function(e,i){l._transferProgress(e.loaded,e.total,i)}}),l.value&&(l.fileName?(l.fileId=l.value,l.file={fileId:l.value,name:l.fileName,valid:!0},l.el.value=l.value,l.tip(l.fileName),l.icoLoding.style.display="none",l.btnClose.style.display="",l.btnDownload.style.display="",l.btnBrowser.style.display="",l.progBarEl.style.width="0%"):l.loadFile(l.value)),l.disabled&&l.setDisabled(!0),l.readonly&&l.setReadonly(!0),e(l.btnClose).tap(function(){if(!(l.disabled||l.readonly||l.loading)&&!0!==l.uploading){if(l.file){!0===l.fileDelete&&l.file.fileId&&e.get(e.FILE_DELETE_URL+"&fileId="+l.file.fileId+"&_="+Math.random());for(var i in l.file)delete l.file[i];l.file=null}l.btnClose.style.display="none",l.btnDownload.style.display="none",l.btnBrowser.style.display="",l.el.value="",l.tip(l.defaultTip,"e_black-light")}}),e(l.btnDownload).tap(function(){if(!l.disabled&&!l.loading&&!0!==l.uploading){var i=l.file?l.file.fileId:null;i&&e.FileTransfer.download(e.FILE_DOWNLOAD_URL+"&fileId="+i+"&realName="+l.file.name+"&needSuffix="+l.needSuffix+"&_="+Math.random())}}),e(l.btnBrowser).tap(function(){if(!(l.disabled||l.readonly||l.loading)&&!0!==l.uploading){if(l.useSwfUpload){var i=swfobject.getFlashPlayerVersion();return void(i&&i.major||alert(e.lang.get("ui.component.swfobject.tip.flashplayer-not-installed")))}l.fileEl.click()}}),e(l.fileEl).bind("change",function(){if(!(l.disabled||l.readonly||l.loading||!0===l.uploading||l.fileEl.files.length<=0)){var e=l.fileEl.files[0];l._setFile(e),l.file&&!l.useSwfUpload&&(l.transfer.file=l.file,l.transfer.send(),l.uploading=!0)}})},_setFile:function(l){var i=this,n=l.name,t=l.size,a=!0;return i.btnClose.style.display="none",i.btnDownload.style.display="none",i._validateFileType(n)?a&&t>i.fileSize?(a=!1,void i.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(i.file={name:n,size:t,valid:a,fileObject:l}):(a=!1,void i.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(l){var i=this;if(!i.fileTypes||!i.fileTypes.length)return!0;var n=e.FileTransfer.extName(l);return n&&e.isString(n)&&e.inArray(n,i.fileTypes)>-1||void 0==n},_transferStart:function(e){var l=this;l.tip(e.name,"e_black-light")},_transferSuccess:function(l,i,n){var t,a,o=this,s=-1;return l&&l.context&&l.data&&(a=l.data.fileId)?(o.uploading=!1,n.fileId=o.el.value=a,n.fileObject=null,o.fileFormEl&&o.fileFormEl.nodeType&&o.fileFormEl.reset(),o.btnClose.style.display="",o.btnDownload.style.display="",o.progBarEl.style.width="0%",o.tip(n.name),void e.event.trigger("afterAction",n,o.el)):(s=l&&l.context?l.context.x_resultcode:"-1",t=l&&l.context?l.context.x_resultinfo:"",void o._transferError.call(o,s,t,n))},_transferError:function(l,i,n){var t=this;t.uploading=!1,n.fileObject=null,t.fileFormEl&&t.fileFormEl.reset(),t.tip(e.lang.get("tapestry.component.simpleupload.tip.upload-faild-info",i?i:"Status("+l+")"),"e_red")},_transferProgress:function(e,l,i){var n=this,t=e>0&&l>0?Math.round(e/l*100):0;t>=100&&(t=99),n.progBarEl.style.width=t+"%",n.tip("("+t+"%) "+i.name)}}),l.SimpleUpload=e.SimpleUpload=n}}(window.Wade,window,document);