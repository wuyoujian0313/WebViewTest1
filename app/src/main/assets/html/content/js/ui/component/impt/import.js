/*!
 * import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(t,e,i){"use strict";function o(t){return l&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement}if(t&&"undefined"==typeof t.Import){var l=(Array.prototype.splice,"undefined"!=typeof t.hasTouch?t.hasTouch:"ontouchstart"in e),n=l?"touchstart":"mousedown",r=t.os.phone||!0===t.ratioPhone,a=3e3,s=null,p=function(e,o){var l=this;l.el=e&&1==e.nodeType?e:i.getElementById(e),l.el&&l.el.nodeType&&(l.id=t.attr(l.el,"id"))&&(o&&t.isObject(o)&&t.extend(l,o),t.attr(l.el,"x-wade-uicomponent")||t.attr(l.el,"x-wade-uicomponent","import"),l._init(),l.constructor.call(l))};p.prototype=t.extend(new t.UIComponent,{setParams:function(e){var i=this;e&&t.isString(e)&&(i.params=e)},buildParams:function(e){var i=this,o=[];return o.push("rpcSessionId="+i.rpcSessionId),o.push("pushMode="+i.pushMode),o.push("config="+(i.configFile?i.configFile:"")),o.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),o.push("filePath="+(i.filePath?i.filePath:"import")),o.push("fileId="+(i.file?i.file.fileId:"")),o.push("fileName="+(i.file?encodeURIComponent(i.file.name):"")),o.push("fileType="+(i.fileType?i.fileType:"")),o.push("model="+(i.model?i.model:"")),o.push("posX="+(i.posX?i.posX:"")),o.push("posY="+(i.posY?i.posY:"")),o.push("txtSplit="+(i.txtSplit?i.txtSplit:"")),o.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),o.push("taskId="+(i.taskId?i.taskId:"")),o.push("serviceName="+(i.taskId?i.taskId:"")),o.push("listenerMethod="+(e?e:"")),t.ajax.buildSubmitData(i.cond,o.join("&")+(i.params&&t.isString(i.params)?"&"+i.params:""))},tip:function(t,e){var i=this;void 0!=t&&(i.tipEl.innerHTML=t),void 0!=e&&(i.tipEl.className=e)},show:function(){var e=this;e.adjust(),e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-fold");var i=e.floatEl.className?e.floatEl.className:"";(" "+i+" ").indexOf(" c_float-show ")<0&&(e.floatEl.className=t.trim(i+" c_float-show"));var o=e.browserButton.offsetWidth,l=e.browserButton.offsetHeight;e.swfup&&e.swfup.settings&&(e.swfup.settings.button_width!=o||e.swfup.settings.button_height!=l)&&e.swfup.setButtonDimensions(o,l)},hide:function(){var e=this;e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-unfold");var i=e.floatEl.className?e.floatEl.className:"";e.floatEl.className=t.trim((" "+i+" ").replace(/ c_float-show /gi," "))},adjust:function(){var t=this;if(!r){var e,o,l=i.body.offsetWidth,n=i.body.offsetHeight,a=t.icoMode?t.buttonIco.getBoundingClientRect():t.button.getBoundingClientRect(),s=t.icoMode?t.buttonIco.offsetWidth:t.button.offsetWidth,p=t.icoMode?t.buttonIco.offsetHeight:t.button.offsetHeight,f="buttom",d="right";t.floatEl.style.left="-99999px",t.floatEl.style.top="-99999px",t.floatEl.style.display="block",e=t.floatEl.offsetWidth,o=t.floatEl.offsetHeight,t.floatEl.style.display="",a.top+p+o>n&&(f="top"),a.left+e>l&&(d="left"),"top"==f?t.floatEl.style.top=a.top-o+"px":t.floatEl.style.top=a.top+p+"px","left"==d?t.floatEl.style.left=Math.max(a.left+s-e,0)+"px":t.floatEl.style.left=a.left+"px"}},getDisabled:function(){var t=this;return t.disabled},setDisabled:function(e){var i=this;i.disabled=!!e;var o=i.icoMode?i.buttonIco:i.button,l=o.className?o.className:"";i.disabled?(" "+l+" ").indexOf(" e_dis ")<0&&(o.className=t.trim(l+" e_dis")):(l=t.trim((" "+l+" ").replace(/ e_dis /gi," ")),o.className=l)},destroy:function(){var t=this;if(t.rpc&&(t.rpc.destroy(),t.rpc=null),t.file){for(var e in t.file)delete t.file[e];t.file=null}t.swfup&&(t.swfup.destroy(),t.swfup=null),t.transfer&&(t.transfer.destroy(),t.transfer=null),t.button=null,t.buttonIco=null,t.buttonIcoFold=null,t.buttonProg=null,t.buttonProgBar=null,t.floatEl=null,t.bgEl=null,t.fileForm=null,t.fileEl=null,t.nameEl=null,t.browserButton=null,t.importButton=null,t.progEl=null,t.progBarEl=null,t.tipEl=null,t.el=null,t.defaultTip=null},_init:function(){var e=this;e.url=t.FILE_UPLOAD_URL+(e.ftpCode?"&ftpSite="+e.ftpCode:"")+(e.filePath?"&filePath="+e.filePath:""),e.button=i.getElementById(e.id+"_button"),e.buttonIco=i.getElementById(e.id+"_button_icoimp"),e.buttonIcoFold=t(e.button).children("span.e_ico-unfold:first")[0],e.buttonProg=t(e.button).children("span.e_buttonProgress:first")[0],e.buttonProgBar=t(e.buttonProg).children("span.e_buttonBar:first")[0],e.floatEl=i.getElementById(e.id+"_float"),e.bgEl=t(e.floatEl).children("div.bg:first")[0];var o=t(e.floatEl).children("div.content:first"),l=o.children("div:first"),r=l.children("span.e_mix:first");e.fileForm=o.children("form:first")[0],e.fileEl=t(e.fileForm).children("input:first")[0],e.nameEl=r.children("input[type=text]:first")[0],e.browserButton=r.children("span.e_ico-browse:first")[0],e.importButton=r.find("span.e_ico-import:first").parent("button:first")[0],e.progEl=r.children("span.e_mixProgress:first")[0],e.progBarEl=t(e.progEl).children("span.e_mixBar:first")[0],e.tipEl=l.children("div:last")[0],o=null,l=null,r=null,e.auto||(e.importButton.style.display=""),t.attr(e.nameEl,"readOnly",!0),t(e.nameEl).focus(function(){this.blur()}),e.fileTypes&&(e.fileTypes=t.FileTransfer.fileTypes(e.fileTypes),e.fileTypes&&t.attr(e.fileEl,"accept",t.FileTransfer.mimeType(e.fileTypes))),e.fileTypeTip=e.fileTypes&&e.fileTypes.length?t.lang.get("ui.component.import.tip.support-filetypes",e.fileTypes.join(",")):"",e.templateTip=e.templateFile&&t.isString(e.templateFile)?'&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+e.templateFile+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.tpldownload")+"]</a>":"",e.tip(e.fileTypeTip+e.templateTip),e.rpcSessionId=t.expando+"_"+t.rand(1e6)+"_"+e.id,e.useSwfUpload=t.browser.msie&&t.browser.version<10,1==e.useSwfUpload?(t(e.browserButton).append('<span id="'+e.id+'_swfupload_holder"></span>'),e.swfup=new SWFUpload({upload_url:e.url,file_size_limit:e.fileSize,file_types:e.fileTypes&&e.fileTypes.length?(""+e.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:e.id+"_swfupload_holder",button_width:e.browserButton.offsetWidth,button_height:e.browserButton.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(i){if(e.auto&&!1===t.event.trigger("beforeAction",null,e.el))for(var o=this.getStats();o.files_queued>0;)this.cancelUpload(null,!1),o=this.getStats();else e._setFile(i),e.nameEl.value=e.file.name,this.startUpload()},file_queue_error_handler:function(i,o,l){switch(o){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(t.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(t.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(t.lang.get("ui.component.upload.tip.file-num-limit",e.fileLimit))}},upload_start_handler:function(t){e._transferStart(e.file)},upload_progress_handler:function(t,i,o){e._transferProgress(i,o,e.file)},upload_success_handler:function(i,o){e._transferSuccess(t.parseJSON(o),"suc",e.file)},upload_error_handler:function(t,i,o){e._transferError(i,o,e.file)}})):e.transfer=new t.FileTransfer({context:e,url:e.url,start:e._transferStart,success:e._transferSuccess,error:e._transferError,progress:function(t,i){e._transferProgress(t.loaded,t.total,i)}}),e.disabled&&e.setDisabled(!0),t(e.icoMode?e.buttonIco:e.button).tap(function(){e.disabled||((" "+e.floatEl.className+" ").indexOf(" c_float-show ")<0?e.show():e.hide())}),t(e.bgEl).bind(n,function(){e.hide()}),t(e.browserButton).tap(function(){if(!e.disabled&&!0!==e.uploading&&!0!==e.importing){if(e.useSwfUpload){var i=swfobject.getFlashPlayerVersion();return void(i&&i.major||alert(t.lang.get("ui.component.swfobject.tip.flashplayer-not-installed")))}e.fileEl.click()}}),t(e.fileEl).bind("change",function(){if(!e.disabled&&!0!==e.uploading&&!0!==e.importing&&!e.useSwfUpload){if(e.auto&&!1===t.event.trigger("beforeAction",null,e.el))return e.fileForm&&e.fileForm.reset(),void e.hide();if(!(e.fileEl.files.length<=0)){var i=e.fileEl.files[0];e._setFile(i),e.file&&(e.nameEl.value=e.file.name,e.transfer.file=e.file,e.transfer.send(),e.uploading=!0)}}}),e.auto||t(e.importButton).tap(function(){e.disabled||!0!==e.uploading&&!0!==e.importing&&1==e.importReady&&!1!==t.event.trigger("beforeAction",null,e.el)&&e._doImport()})},_setFile:function(e){var i=this,o=e.name,l=e.size,n=!0;return i._validateFileType(o)?n&&l>i.fileSize?(n=!1,void i.tip(t.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(i.file={name:o,size:l,valid:n,fileObject:e}):(n=!1,void i.tip(t.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(e){var i=this;if(!i.fileTypes||!i.fileTypes.length)return!0;var o=t.FileTransfer.extName(e);return o&&t.isString(o)&&t.inArray(o,i.fileTypes)>-1||void 0==o},_transferStart:function(e){var i=this;i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(t.lang.get("ui.component.import.tip.begin-upload",e.name),"")},_transferSuccess:function(e,i,o){var l,n,r=this,a=-1;return e&&e.context&&e.data&&(n=e.data.fileId)?(r.uploading=!1,r.importReady=!0,o.fileId=r.el.value=n,o.fileObject=null,r.fileForm&&r.fileForm.reset(),r.buttonProgBar&&(r.buttonProgBar.style.width="0%"),r.progBarEl.style.width="0%",r.tip(t.lang.get("ui.component.import.tip.upload-complete")),void(r.auto&&r._doImport())):(a=e&&e.context?e.context.x_resultcode:"-1",l=e&&e.context?e.context.x_resultinfo:"",void r._transferError.call(r,a,l,o))},_transferError:function(e,i,o){var l=this;l.uploading=!1,o.fileObject=null,l.fileForm&&l.fileForm.reset(),l.tip(t.lang.get("tapestry.component.import.tip.upload-faild-info",i?i:"Status("+e+")"),"e_red")},_transferProgress:function(e,i,o){var l=this,n=e>0&&i>0?Math.round(e/i*100):0;n>=100&&(n=99),l.buttonProgBar&&(l.buttonProgBar.style.width=n+"%"),l.progBarEl.style.width=n+"%",l.tip(t.lang.get("ui.component.import.tip.uploading",n,o.name))},_doImport:function(){var i=this;i.fileSerializeId=null,i.tip(t.lang.get("ui.component.import.tip.begin-import",i.file.name)),t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(o){if(i.fileSerializeId=o.fileSerializeId,i.messageServer=o.messageServer,i.messageServerType=o.messageServerType?o.messageServerType:null,!0===i.importing)if("10"==o.progress)i.tip(t.lang.get("ui.component.import.tip.import-started"));else{if(!i.fileSerializeId&&"error"==o.status)return i.importing=!1,i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",void i.tip(o.hint,"e_red");i.buttonProgBar&&(i.buttonProgBar.style.width=o.progress+"%"),i.progBarEl.style.width=o.progress+"%",i.tip(t.lang.get("ui.component.import.tip.importing",o.progress+"%",i.file.name))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new t.RPC({address:i.messageServer,session:"&sessionId="+i.rpcSessionId,type:i.messageServerType,message:function(e){if(e&&t.isObject(e))if("prog"!=e.STATUS){if(i.importing=!1,i.importReady=!1,"ok"==e.STATUS){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var o=e.ERROR_INFO,l=i.downUrl=e.DOWNLOAD_URL,n=t.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(o)){var r=o.split(",");n+=" "+t.lang.get("ui.component.import.tip.import-count",r[0],r[1])}else n=o;l&&(n+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+l+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),i.tip(n,"")}else"error"==e.STATUS&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(e.ERROR_INFO,"e_red"));t.event.trigger("afterAction",e.STATUS,i.el)}else if(e.PROG){var a=(""+e.PROG).indexOf("%")>-1?e.PROG:e.PROG+"%";i.buttonProgBar&&(i.buttonProgBar.style.width=a),i.progBarEl.style.width=a,i.tip(t.lang.get("ui.component.import.tip.importing",a,i.file.name))}}}),i.rpc.open()):i.timer=e.setInterval(function(){return i.fileSerializeId?void t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(o){if(!o||!t.isObject(o))return void e.clearInterval(i.timer);if("100"==o.progress||"error"==o.status){if(e.clearInterval(i.timer),i.importing=!1,i.importReady=!1,"ok"==o.status){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var l=o.hint,n=i.downUrl=o.downloadUrl,r=t.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(l)){var a=l.split(",");r+=" "+t.lang.get("ui.component.import.tip.import-count",a[0],a[1])}else r=l;n&&(r+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+n+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),i.tip(r,"")}else"error"==o.status&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(o.hint,"e_red"));t.event.trigger("afterAction",o.status,i.el)}},error:function(o,l,n){e.clearInterval(i.timer),i.importing=!1,i.importReady=!1,i.tip(t.lang.get("ui.component.import.tip.import-faild",l),"e_red")}}):void e.clearInterval(i.timer)},a)},error:function(e,o,l){i.importing=!1,i.importReady=!1,i.tip(t.lang.get("ui.component.import.tip.import-faild",o),"e_red")}}),i.importing=!0}}),t(function(){t(i.body).bind(n,function(l){l.originalEvent&&(l=l.originalEvent);var n=o(l);if(n&&n.nodeType){for(var r,a,f=0,d=n,u=!1;d&&d.nodeType&&d!=i.body&&f<50&&((r=t.attr(d,"id"))&&(a=r.substring(0,r.indexOf("_")),(t.nodeName(d,"button")||(""+d.className).indexOf("e_ico-import")>-1)&&a?u=e[a]&&e[a]instanceof p:t.nodeName(d,"div")&&(" "+d.className+" ").indexOf(" c_float ")>-1&&a&&(u=e[a]&&e[a]instanceof p)),1!=u);)d=d.parentNode,f++;s&&(!u||u&&a!=s)&&e[s].hide(),s=u?a:null}}),t(e).bind("onorientationchange"in e?"orientationchange":"resize",function(){s&&e[s]&&(e[s].hide(),s=null)})}),e.Import=t.Import=p}}(window.Wade,window,document);