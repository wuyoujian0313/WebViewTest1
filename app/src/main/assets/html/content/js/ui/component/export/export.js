/*!
 * export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(t,e,o){"use strict";function i(t){return n&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement}if(t&&"undefined"==typeof t.Export){var n=(Array.prototype.splice,"undefined"!=typeof t.hasTouch?t.hasTouch:"ontouchstart"in e),r=n?"touchstart":"mousedown",l=t.os.phone||!0===t.ratioPhone,a=3e3,s=null,p=function(e,i){var n=this;n.el=e&&1==e.nodeType?e:o.getElementById(e),n.el&&n.el.nodeType&&(n.id=t.attr(n.el,"id"))&&(i&&t.isObject(i)&&t.extend(n,i),t.attr(n.el,"x-wade-uicomponent")||t.attr(n.el,"x-wade-uicomponent","export"),n._init(),n.constructor.call(n))};p.prototype=t.extend(new t.UIComponent,{setParams:function(e){var o=this;e&&t.isString(e)&&(o.params=e)},buildParams:function(e){var o=this,i=[];return i.push("rpcSessionId="+o.rpcSessionId),i.push("pushMode="+o.pushMode),i.push("config="+(o.configFile?o.configFile:"")),i.push("ftpSite="+(o.ftpCode?o.ftpCode:"")),i.push("filePath="+(o.filePath?o.filePath:"export")),i.push("fileId="+(o.file?o.file.fileId:"")),i.push("fileType="+(o.fileType?o.fileType:"")),i.push("model="+(o.model?o.model:"")),i.push("posX="+(o.posX?o.posX:"")),i.push("posY="+(o.posY?o.posY:"")),i.push("fileSerializeId="+(o.fileSerializeId?o.fileSerializeId:"")),i.push("taskId="+(o.taskId?o.taskId:"")),i.push("serviceName="+(o.taskId?o.taskId:"")),i.push("listenerMethod="+(e?e:"")),i.push("fileName="+encodeURIComponent(o.fileName)),t.ajax.buildSubmitData(o.cond,i.join("&")+(o.params&&t.isString(o.params)?"&"+o.params:""))},tip:function(t,e){var o=this;void 0!=t&&(o.tipEl.innerHTML=t),void 0!=e&&(o.tipEl.className=e)},show:function(){var e=this;e.adjust(),e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-fold");var o=e.floatEl.className?e.floatEl.className:"";(" "+o+" ").indexOf(" c_float-show ")<0&&(e.floatEl.className=t.trim(o+" c_float-show"))},hide:function(){var e=this;e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-unfold");var o=e.floatEl.className?e.floatEl.className:"";e.floatEl.className=t.trim((" "+o+" ").replace(/ c_float-show /gi," "))},adjust:function(){var t=this;if(!l){var e,i,n=o.body.offsetWidth,r=o.body.offsetHeight,a=t.icoMode?t.buttonIco.getBoundingClientRect():t.button.getBoundingClientRect(),s=t.icoMode?t.buttonIco.offsetWidth:t.button.offsetWidth,p=t.icoMode?t.buttonIco.offsetHeight:t.button.offsetHeight,d="buttom",u="right";t.floatEl.style.left="-99999px",t.floatEl.style.top="-99999px",t.floatEl.style.display="block",e=t.floatEl.offsetWidth,i=t.floatEl.offsetHeight,t.floatEl.style.display="",a.top+p+i>r&&(d="top"),a.left+e>n&&(u="left"),"top"==d?t.floatEl.style.top=a.top-i+"px":t.floatEl.style.top=a.top+p+"px","left"==u?t.floatEl.style.left=Math.max(a.left+s-e,0)+"px":t.floatEl.style.left=a.left+"px"}},getDisabled:function(){var t=this;return t.disabled},setDisabled:function(e){var o=this;o.disabled=!!e;var i=o.icoMode?o.buttonIco:o.button,n=i.className?i.className:"";o.disabled?(" "+n+" ").indexOf(" e_dis ")<0&&(i.className=t.trim(n+" e_dis")):(n=t.trim((" "+n+" ").replace(/ e_dis /gi," ")),i.className=n)},destroy:function(){var t=this;t.rpc&&(t.rpc.destroy(),t.rpc=null),t.button=null,t.buttonIco=null,t.buttonIcoFold=null,t.buttonProg=null,t.buttonProgBar=null,t.floatEl=null,t.bgEl=null,t.nameEl=null,t.exportButton=null,t.progEl=null,t.progBarEl=null,t.tipEl=null,t.el=null},_init:function(){var i=this;i.button=o.getElementById(i.id+"_button"),i.buttonIco=o.getElementById(i.id+"_button_icoexp"),i.buttonIcoFold=t(i.button).children("span.e_ico-unfold:first")[0],i.buttonProg=t(i.button).children("span.e_buttonProgress:first")[0],i.buttonProgBar=t(i.buttonProg).children("span.e_buttonBar:first")[0],i.floatEl=o.getElementById(i.id+"_float"),i.bgEl=t(i.floatEl).children("div.bg:first")[0];var n=t(i.floatEl).children("div.content:first"),l=n.children("div:first"),s=l.children("span.e_mix:first");i.nameEl=s.children("input[type=text]:first")[0],i.exportButton=s.find("span.e_ico-export:first").parent("button:first")[0],i.progEl=s.children("span.e_mixProgress:first")[0],i.progBarEl=t(i.progEl).children("span.e_mixBar:first")[0],i.tipEl=l.children("div:last")[0],n=null,l=null,s=null,i.fileTypes&&(i.fileTypes=t.FileTransfer.fileTypes(i.fileTypes)),i.rpcSessionId=t.expando+"_"+t.rand(1e6)+"_"+i.id,i.disabled&&i.setDisabled(!0),i.tip(t.lang.get("ui.component.export.tip.input-filename")),t(i.icoMode?i.buttonIco:i.button).tap(function(){i.disabled||((" "+i.floatEl.className+" ").indexOf(" c_float-show ")<0?i.show():i.hide())}),t(i.bgEl).bind(r,function(){i.hide()}),t(i.exportButton).tap(function(){if(!i.disabled&&!0!==i.exporting){var o=t.trim(i.nameEl.value);if(o&&o.indexOf(".")>-1&&(o=o.substring(0,o.indexOf("."))),o){var n=t("#"+i.id+"_filetype_sel").val();if(i.fileTypes&&t.inArray(n,i.fileTypes)<0)return void i.tip(t.lang.get("ui.component.export.tip.invalid-filename"),"e_red");if(o=i.fileName=o+n,!1===t.event.trigger("beforeAction",null,i.el))return void i.hide();i.fileSerializeId=null,i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",t.attr(i.nameEl,"readOnly",!0),i.tip(t.lang.get("ui.component.export.tip.begin-export",o),""),t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(o){if(i.fileSerializeId=o.fileSerializeId,i.messageServer=o.messageServer,i.messageServerType=o.messageServerType?o.messageServerType:null,!0===i.exporting)if("10"==o.progress)i.tip(t.lang.get("ui.component.export.tip.export-started"));else{if(!i.fileSerializeId&&"error"==o.status)return i.exporting=!1,i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",void i.tip(o.hint,"e_red");i.buttonProgBar&&(i.buttonProgBar.style.width=o.progress+"%"),i.progBarEl.style.width=o.progress+"%",i.tip(t.lang.get("ui.component.export.tip.exporting",o.progress+"%",i.fileName))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new t.RPC({address:i.messageServer,type:i.messageServerType,session:"&sessionId="+i.rpcSessionId,message:function(e){if(e&&t.isObject(e))if("prog"!=e.STATUS){if(i.exporting=!1,"ok"==e.STATUS){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var o=i.downUrl=e.DOWNLOAD_URL,n=t.lang.get("ui.component.export.tip.export-complete");o&&(n+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+o+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),i.tip(n,"")}else"error"==e.STATUS&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(e.ERROR_INFO,"e_red"));t.attr(i.nameEl,"readOnly",!1),t.event.trigger("afterAction",e.STATUS,i.el)}else if(e.PROG){var r=(""+e.PROG).indexOf("%")>-1?e.PROG:e.PROG+"%";i.buttonProgBar&&(i.buttonProgBar.style.width=r),i.progBarEl.style.width=r,i.tip(t.lang.get("ui.component.export.tip.exporting",r,i.fileName))}}}),i.rpc.open()):i.timer=e.setInterval(function(){return i.fileSerializeId?void t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(o){if(!o||!t.isObject(o))return void e.clearInterval(i.timer);if("100"==o.progress||"error"==o.status){if(e.clearInterval(i.timer),i.exporting=!1,"ok"==o.status){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var n=i.downUrl=o.downloadUrl,r=t.lang.get("ui.component.export.tip.export-complete");n&&(r+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+n+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),i.tip(r,"")}else"error"==o.status&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(o.hint,"e_red"));t.attr(i.nameEl,"readOnly",!1),t.event.trigger("afterAction",o.status,i.el)}},error:function(o,n,r){e.clearInterval(i.timer),i.exporting=!1,i.tip(t.lang.get("ui.component.export.tip.export-faild",n),"e_red")}}):void e.clearInterval(i.timer)},a)},error:function(e,o,n){i.exporting=!1,i.tip(t.lang.get("ui.component.export.tip.export-faild",o),"e_red")}}),i.exporting=!0}}})}}),t(function(){t(o.body).bind(r,function(n){n.originalEvent&&(n=n.originalEvent);var r=i(n);if(r&&r.nodeType){for(var l,a,d=0,u=r,f=!1;u&&u.nodeType&&u!=o.body&&d<50&&((l=t.attr(u,"id"))&&(a=l.substring(0,l.indexOf("_")),(t.nodeName(u,"button")||(""+u.className).indexOf("e_ico-export")>-1)&&a?f=e[a]&&e[a]instanceof p:t.nodeName(u,"div")&&(" "+u.className+" ").indexOf(" c_float ")>-1&&a&&(f=e[a]&&e[a]instanceof p)),1!=f);)u=u.parentNode,d++;s&&(!f||f&&a!=s)&&e[s].hide(),s=f?a:null}}),t(e).bind("onorientationchange"in e?"orientationchange":"resize",function(){s&&e[s]&&(e[s].hide(),s=null)})}),e.Export=t.Export=p}}(window.Wade,window,document);