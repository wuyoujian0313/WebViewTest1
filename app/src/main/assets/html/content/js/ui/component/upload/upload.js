/*!
 * upload component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,l,i){"use strict";if(e&&"undefined"==typeof e.Upload){var t=Array.prototype.push,n=Array.prototype.splice,a="undefined"!=typeof e.hasTouch?e.hasTouch:"ontouchstart"in l,s=a?"touchstart":"mousedown",r=e.os.phone||!0===e.ratioPhone,d={excel:[".xls",".xlsx",".csv"],img:[".png",".jpg",".gif"],ppt:[".ppt",".pptx",".ppsx"],rar:[".rar",".zip",".tar",".gz",".tgz"],video:[".rm",".rmvb",".avi",".mkv",".mp4",".wmv",".mov",".movie",".mpeg",".mpg",".qt"],voice:[".mp2",".mp3",".wma",".midi"],word:[".doc",".docx"]},o={excel:"e_ico-excel",img:"e_ico-img",ppt:"e_ico-ppt",rar:"e_ico-rar",video:"e_ico-video",voice:"e_ico-voice",word:"e_ico-word",unknown:"e_ico-file"},f=function(l,t){var n=this;n.el=l&&1==l.nodeType?l:i.getElementById(l),n.el&&n.el.nodeType&&(n.id=e.attr(n.el,"id"))&&(t&&e.isObject(t)&&e.extend(n,t),e.attr(n.el,"x-wade-uicomponent")||e.attr(n.el,"x-wade-uicomponent","upload"),n._init(),n.constructor.call(n))};f.prototype=e.extend(new e.UIComponent,{val:function(){var l=this,i=[],t=[];if(l.files&&!e.isEmptyObject(l.files)){var n;for(var a in l.files)n=l.files[a],n.valid&&n.fileId&&(i.push(n.name),t.push(n.fileId))}var s=new Object;return s.NAME=i.join(","),s.ID=t.join(","),i=t=null,s},fileSet:function(){var l=this,i=new Array;if(l.files&&!e.isEmptyObject(l.files)){var t;for(var n in l.files)t=l.files[n],t.valid&&t.fileId&&i.push({name:t.name,fileId:t.fileId})}return i},tip:function(l){var i=this;l&&e.isString(l)&&(i.tipCtEl.innerHTML=l)},loadFile:function(l){var i=this;if(e.isString(l)&&e.trim(l)){var t=l.split(",");if(t&&t.length){for(var n={},a=t.length-1;a>=0;a--){var s=e.md5(t[a]);i.files[s]?t.splice(a,1):n[t[a]]=s}t&&t.length&&(e(i.loadingTitle).text(e.lang.get("ui.component.upload.tip.loading-files")),e(i.loadingEl).removeClass("c_msg-error"),e(i.loadingEl).addClass("c_msg-loading"),e(i.loadingEl).css("display",""),i.loading=!0,e.ajaxRequest({url:e.FILE_QUERY_URL,data:"&fileId="+t.join(","),dataType:"text",success:function(l,t,a){var s,r=!1;try{s=e.parseJSON(l),s.context&&s.data&&"0"==s.context.x_resultcode||(r=!0)}catch(d){r=!0}if(r)e(i.loadingTitle).text(e.lang.get("ui.component.upload.tip.loading-files-faild")),e(i.loadingEl).addClass("c_msg-error"),e(i.loadingEl).removeClass("c_msg-loading");else{for(var o in s.data){var f=n[o],p=s.data[o],u=i.files[f]={guid:f,fileId:o,name:p.fileName,size:parseInt(p.fileSize),valid:!0},c=i._fileIconClassName(u.fileName);e(i.listUlEl).append('<li id="'+i.id+"_file_"+f+'">\t<div class="pic"><span id="'+i.id+"_file_"+f+'_ico" class="e_ico-pic '+c+'"></span></div>\t<div class="main">\t\t<div class="title">'+u.name+'</div>\t\t<div class="content">       \t\t<span id="'+i.id+"_file_"+f+'_text">'+e.FileTransfer.humanSize(u.size)+'</span>      </div>\t</div>\t<div class="side"><span id="'+i.id+"_file_"+f+'_tag" class="e_tag e_tag-green">'+e.lang.get("ui.component.upload.tip.tag-uploaded")+'</span></div>\t<div class="fn" tag="download"><span id="'+i.id+"_file_"+f+'_download" ontap="$.Upload.downloadFile(\''+o+"','"+u.name+"', "+i.needSuffix+')" class="e_ico-download"></span></div>\t<div class="fn" tag="delete" style="'+(i.readonly?"display:none":"")+'"><span id="'+i.id+"_file_"+f+'_delete" ontap="$.Upload.removeFile(\''+i.id+"','"+f+'\')" class="e_ico-delete"></span></div></li>')}i.scroller&&i.scroller.refresh(),e(i.loadingEl).css("display","none")}i.loading=!1},error:function(l,t,n){e(i.loadingTitle).text(e.lang.get("ui.component.upload.tip.loading-files-faild")),e(i.loadingEl).addClass("c_msg-error"),e(i.loadingEl).removeClass("c_msg-loading"),i.loading=!1}}))}}},removeFile:function(l){var i=this;if(!(i.queue.length>0)){var t=i.files[l];if(t){!0===i.fileDelete&&t.fileId&&e.get(e.FILE_DELETE_URL+"&fileId="+t.fileId+"&_="+Math.random());var n=i.transfers[l];n&&(n.destroy(),n=null);for(var a in t)delete t[a];delete i.files[l],t=null}e("#"+i.id+"_file_"+l).remove(),i.fileFormEl&&i.fileFormEl.nodeType&&i.fileFormEl.reset(),i.scroller&&i.scroller.refresh()}},reset:function(l){var i=this;if(!(i.queue.length>0)){for(var t in i.files){var n=i.files[t];if(n){!0===i.fileDelete&&!0===l&&n.fileId&&e.get(e.FILE_DELETE_URL+"&fileId="+n.fileId+"&_="+Math.random());var a=i.transfers[t];a&&(a.destroy(),a=null);for(var s in n)delete n[s];delete i.files[t],n=null}e("#"+i.id+"_file_"+t).remove()}i.fileFormEl&&i.fileFormEl.nodeType&&i.fileFormEl.reset(),i.scroller&&i.scroller.refresh()}},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(l){var i=this;i.disabled=!!l;var t=i.el.className?i.el.className:"";i.disabled?(" "+t+" ").indexOf(" e_dis ")<0&&(i.el.className=e.trim(t+" e_dis")):(t=e.trim((" "+t+" ").replace(/ e_dis /gi," ")),i.el.className=t)},getReadonly:function(){var e=this;return e.readonly},setReadonly:function(l){var i=this;i.readonly=!!l,e(i.listUlEl).find("div[tag=delete]").each(function(){this.style.display=i.readonly?"none":""}),i.btnSelEl.style.display=i.btnDoEl.style.display=i.btnOk.style.display=i.btnClear.style.display=i.readonly?"none":""},destroy:function(){var e=this;if(e.files){var l;for(var i in e.files){l=e.files[i];for(var t in l)delete l[t];l.fileObject=null,delete e.files[i]}l=null,e.files=null}if(e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfers){for(var i in e.transfers)e.transfers[i].destroy(),delete e.transfers[i];e.transfers=null}e.queue=null,e.scroller&&(e.scroller.destroy(),e.scroller=null),e.fileFormEl=null,e.fileEl=null,e.btnSelEl=null,e.btnBrow=null,e.btnDoEl=null,e.tipCtEl=null,e.scrollEl=null,e.listUlEl=null,e.loadingEl=null,e.loadingTitle=null,e.btnOk=null,e.btnClear=null,e.el=null,e.defaultTip=null},_init:function(){var l=this;l.url=e.FILE_UPLOAD_URL+"&needSuffix="+l.needSuffix+(l.ftpCode?"&ftpSite="+l.ftpCode:"")+(l.filePath?"&filePath="+encodeURIComponent(l.filePath):"")+(l.copyToFtpCode?"&copyToFtpSite="+l.copyToFtpCode:"")+(l.copyToFilePath?"&copyToFilePath="+encodeURIComponent(l.copyToFilePath):"");var i=e(l.el).children("div.c_header:first")[0],t=e(i).children("div.fn:first")[0];l.fileFormEl=e(t).children("form:first")[0],l.fileEl=e(l.fileFormEl).children("input:first")[0],l.btnSelEl=e(t).children("span.e_flash:first")[0],l.btnBrow=e(l.btnSelEl).children("button.e_button-blue:first")[0],l.btnDoEl=e(t).children("button.e_button-blue:first")[0],t=null,i=null,l.tipCtEl=e(l.el).children("div.c_tip:first").children("div:first")[0],l.scrollEl=e(l.el).children("div.c_scroll:first")[0],l.listUlEl=e(l.scrollEl).children("div.c_scrollContent:first").find("ul:first")[0],l.loadingEl=e(l.scrollEl).children("div.c_msg:first")[0],l.loadingTitle=e(l.loadingEl).find("div.title:first")[0];var n=e(l.el).children("div.c_submit:first").children("div:first")[0];l.btnOk=e(n).children("button[tag=ok]:first")[0],l.btnClear=e(n).children("button[tag=clear]:first")[0],n=null,(r||e.os.pad)&&(l.scroller=new e.Scroll(l.scrollEl,{hScroll:!1,hScrollbar:!1})),l.fileTypes&&(l.fileTypes=e.FileTransfer.fileTypes(l.fileTypes),l.fileTypes&&e.attr(l.fileEl,"accept",e.FileTransfer.mimeType(l.fileTypes))),l.defaultTip=e.lang.get("ui.component.upload.tip.file-size-limit",e.FileTransfer.humanSize(l.fileSize))+e.lang.get("ui.component.upload.tip.file-num-limit",l.fileLimit),l.fileTypes&&(l.defaultTip+=e.lang.get("ui.component.upload.tip.file-type-limit",l.fileTypes.join(","))),l.tip(l.defaultTip),l.files={},l.transfers={},l.queue=[],l.disabled&&l.setDisabled(!0),l.readonly&&l.setReadonly(!0),l.useSwfUpload=e.browser.msie&&e.browser.version<10,1==l.useSwfUpload&&(e(l.btnSelEl).append('<span id="'+l.id+'_swfupload_holder"></span>'),l.swfup=new SWFUpload({upload_url:l.url,file_size_limit:l.fileSize,file_queue_limit:l.fileLimit,file_types:l.fileTypes&&l.fileTypes.length?(""+l.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:l.id+"_swfupload_holder",button_width:l.btnSelEl.offsetWidth,button_height:l.btnSelEl.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){l._addFile(e)},file_queue_error_handler:function(i,t,n){switch(t){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(e.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(e.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(e.lang.get("ui.component.upload.tip.file-num-limit",l.fileLimit))}},upload_start_handler:function(e){var i=l._fileObjGUID(e),t=l.files[i];l._transferStart(t)},upload_progress_handler:function(e,i,t){var n=l._fileObjGUID(e),a=l.files[n];l._transferProgress(i,t,a)},upload_success_handler:function(i,t){var n=l._fileObjGUID(i),a=l.files[n];l._transferSuccess(e.parseJSON(t),"suc",a)},upload_error_handler:function(e,i,t){var n=l._fileObjGUID(e),a=l.files[n];l._transferError(i,t,a)}})),e(l.btnBrow).tap(function(){if(!l.disabled&&!l.readonly&&!(l.loading||l.queue.length>0)){if(l.useSwfUpload){var i=swfobject.getFlashPlayerVersion();return void(i&&i.major||alert(e.lang.get("ui.component.swfobject.tip.flashplayer-not-installed")))}l.fileEl.click()}}),e(l.btnDoEl).tap(function(){if(!l.disabled&&!l.readonly&&!(l.loading||l.queue.length>0))if(l.useSwfUpload)l.swfup.startUpload();else{var e,i;for(var t in l.files)e=l.files[t],e.valid&&!e.fileId&&(i=l.transfers[t])&&i.send()}}),e(l.fileEl).bind("change",function(){if(!l.disabled&&!l.readonly&&!(l.loading||l.queue.length>0)){for(var i=0,t=this.files.length;i<t;i++)l._addFile(this.files[i]);var n=0,a=0;for(var s in l.files)n++,0==l.files[s].valid&&a++;l.scroller&&l.scroller.refresh();var r=e.lang.get("ui.component.upload.tip.selected-file-num",n);a>0&&(r+=e.lang.get("ui.component.upload.tip.selected-invalid-file-num",a)),l.tip(r)}}),e(l.loadingEl).bind(s,function(){l.loading||(l.loadingEl.style.display="none")}),e(l.btnOk).tap(function(i){l.disabled||l.readonly||e.event.trigger({type:"select",originalEvent:i.originalEvent,context:l},null,l.el)}),e(l.btnClear).tap(function(){if(!l.disabled&&!l.readonly&&!l.loading){for(var i in l.files)l.removeFile(i);l.fileFormEl&&l.fileFormEl.nodeType&&l.fileFormEl.reset(),l.tip(l.defaultTip),e.event.trigger("clear",null,l.el)}})},_addFile:function(l){var i=this,t=l.name,n=l.size,a=i._fileObjGUID(l),s=!0,r=e.FileTransfer.humanSize(n);if(!1!==i.fileRepeat||!i.files[a]){i._validateFileType(t)||(s=!1,r+=" "+e.lang.get("ui.component.upload.tip.invalid-filetype")),s&&n>i.fileSize&&(s=!1,r+=" "+e.lang.get("ui.component.upload.tip.invalid-filesize"));var d=i.files[a]={guid:a,name:t,size:n,valid:s,fileObject:l};s&&!i.useSwfUpload&&(i.transfers[a]=new e.FileTransfer({context:i,url:i.url,start:i._transferStart,success:i._transferSuccess,error:i._transferError,progress:function(e,l){i._transferProgress(e.loaded,e.total,l)}},d));var o=i._fileIconClassName(t);return e(i.listUlEl).append('<li id="'+i.id+"_file_"+a+'">\t<div class="pic"><span id="'+i.id+"_file_"+a+'_ico" class="e_dis e_ico-pic '+o+'"></span></div>\t<div class="main">\t\t<div class="title">'+t+'</div>\t\t<div class="content">       \t\t<span id="'+i.id+"_file_"+a+'_text" '+(s?"":' class="e_red" ')+">"+r+'</span>\t\t\t\t<span id="'+i.id+"_file_"+a+'_prog"class="e_progress e_progress-s" style="display:none">\t\t\t\t\t<span class="e_progressBar">\t\t\t\t\t\t<span id="'+i.id+"_file_"+a+'_prog_bar" class="e_progressProgress" style="width:0.0%;"></span>\t\t\t\t\t</span>\t\t\t\t</span>      </div>\t</div>\t<div class="side"><span id="'+i.id+"_file_"+a+'_tag" class="e_tag">'+e.lang.get("ui.component.upload.tip.tag-wait")+'</span></div>\t<div class="fn" tag="download" style="display:none"><span id="'+i.id+"_file_"+a+'_download" class="e_ico-download"></span></div>\t<div class="fn" tag="delete"><span id="'+i.id+"_file_"+a+'_delete" ontap="$.Upload.removeFile(\''+i.id+"','"+a+'\')" class="e_ico-delete"></span></div></li>'),d}},_validateFileType:function(l){var i=this;if(!i.fileTypes||!i.fileTypes.length)return!0;var t=e.FileTransfer.extName(l);return t&&e.isString(t)&&e.inArray(t,i.fileTypes)>-1||void 0==t},_fileIconClassName:function(l){var i=l&&e.isString(l)?e.FileTransfer.extName(l):null;if(i)for(var t in d)if(e.inArray(i,d[t])>-1)return o[t];return o.unknown},_fileObjGUID:function(l){if(l)return e.md5((l.lastModifiedDate?l.lastModifiedDate.valueOf():l.modificationdate)+l.name+l.size)},_transferStart:function(e){var l=this;if(e){t.call(l.queue,e.guid);var n,a,s;(n=i.getElementById(l.id+"_file_"+e.guid+"_text"))&&(n.style.display="none"),(a=i.getElementById(l.id+"_file_"+e.guid+"_prog"))&&(a.style.display=""),(s=i.getElementById(l.id+"_file_"+e.guid+"_delete"))&&(s.className="e_dis e_ico-delete"),n=a=s=null}},_transferSuccess:function(l,t,a){var s,r,d=this,o=-1;if(!(l&&l.context&&l.data&&(r=l.data.fileId)))return o=l&&l.context?l.context.x_resultcode:"-1",s=l&&l.context?l.context.x_resultinfo:"",void d._transferError.call(d,o,s,a);if(a){a.fileId=r,n.call(d.queue,e.inArray(a.guid,d.queue),1);var f,p,u,c,_;(f=i.getElementById(d.id+"_file_"+a.guid+"_prog_bar"))&&(f.style.width="100%",f.innerHTML="100%"),(p=i.getElementById(d.id+"_file_"+a.guid+"_ico"))&&(p.className=e.trim((" "+(p.className?p.className:"")+" ").replace(/ e_dis /gi," "))),(u=i.getElementById(d.id+"_file_"+a.guid+"_tag"))&&(u.className="e_tag e_tag-green",u.innerHTML=e.lang.get("ui.component.upload.tip.tag-complete")),(c=i.getElementById(d.id+"_file_"+a.guid+"_download"))&&(c.parentNode.style.display="",c.setAttribute("ontap","$.Upload.downloadFile('"+r+"', '"+a.name+"', "+d.needSuffix+")")),(_=i.getElementById(d.id+"_file_"+a.guid+"_delete"))&&(_.className="e_ico-delete"),f=p=u=c=_=null}},_transferError:function(l,t,a){var s=this;if(a){n.call(s.queue,e.inArray(a.guid,s.queue),1);var r,d,o,f;(r=i.getElementById(s.id+"_file_"+a.guid+"_text"))&&(r.innerHTML=e.lang.get("ui.component.upload.tip.upload-faild-info",t?t:"Status("+l+")"),r.className="e_red",r.style.display=""),(d=i.getElementById(s.id+"_file_"+a.guid+"_prog"))&&(d.style.display="none"),(o=i.getElementById(s.id+"_file_"+a.guid+"_tag"))&&(o.className="e_tag e_tag-red",o.innerHTML=e.lang.get("ui.component.upload.tip.upload-faild")),(f=i.getElementById(s.id+"_file_"+a.guid+"_delete"))&&(f.className="e_ico-delete"),r=d=o=f=null}},_transferProgress:function(e,l,t){var n,a,s=this;(a=i.getElementById(s.id+"_file_"+t.guid+"_prog_bar"))&&(n=e>0&&l>0?Math.round(e/l*100):0,n>=100&&(n=99),a.style.width=n+"%",a.innerHTML=n+"%"),n=a=null}}),e.extend(f,{removeFile:function(i,t){if(i&&t){var n=l[i];return n&&e.isObject(n)&&n instanceof f?n.removeFile(t):void 0}},downloadFile:function(l,i,t){l&&e.FileTransfer.download(e.FILE_DOWNLOAD_URL+"&fileId="+l+"&realName="+i+"&needSuffix="+!!t+"&_="+Math.random())}}),l.Upload=e.Upload=f}}(window.Wade,window,document);