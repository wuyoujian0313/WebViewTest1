/*!
 * tree component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,a){"use strict";if(e&&"undefined"==typeof e.Tree){var n=Array.prototype.splice,i=("undefined"!=typeof e.hasTouch?e.hasTouch:"ontouchstart"in t,function(t,n){var i=this;i.el=t&&1==t.nodeType?t:a.getElementById(t),i.el&&i.el.nodeType&&(i.id=e.attr(i.el,"id"))&&(n&&e.isObject(n)&&e.extend(i,n),e.attr(i.el,"x-wade-uicomponent")||e.attr(i.el,"x-wade-uicomponent","tree"),i._init(),i.constructor.call(i))});i.prototype=e.extend(new e.UIComponent,{setParam:function(e,t){var a=this;a.params||(a.params={}),a.params[e]=t},getCheckedNodeIds:function(t){var a=this;if(a.isShowCheckBox){var n=[];if(e("input[name="+a.checkBoxName+"]:checked",a.el).each(function(){n.push(e.attr(this.parentNode.parentNode,"id"))}),n.length>1&&t){n.sort(function(e,t){return e.lastIndexOf("●")-t.lastIndexOf("●")});for(var i,d,o=n.length-1;o>-1;o--)(i=a._getDataIdByNodeId(n[o]))&&(d=a._getParentNodeDataByDataId(i),d&&e.inArray(treeId+"○"+d.dataid,n)>-1&&n.splice(o,1))}return n}},init:function(){var t=this;if(t.data)t.draw(),t.expandPath&&t.expandByPath(t.expandPath);else{if(!(t.clazz||t.method||t.listener||t.componentId))return void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.invalid-parameter",t.id));e(t.el).append('<span id="'+t.id+'_loading" class="e_ico-loading"></span>');var a=function(a){e("#"+t.id+"_loading").remove();var n=a.context;return"0"!=n.x_resultcode?void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),n.x_resultinfo):(t.data=a.data,t.draw(),t.expandPath&&t.expandByPath(t.expandPath),void e.event.trigger("afterAction",null,t.el))},n=t._buildParams();t.clazz&&t.method?e.httphandler.post(t.clazz,t.method,n,a,null,{dataType:"json",simple:!0}):e.ajax.post(t.page?t.page:null,t.listener,n,t.componentId?t.componentId:null,a,null,{dataType:"json",simple:!0})}},insert:function(t,a,n,i,d,o,r){var l=this,s=e.isPlainObject(a);if(void 0!=a&&null!=a&&(s||void 0!=n&&null!=n)){s&&void 0==o&&(o=n,n=null);var c;if(!o||(c=l._getNodeDataByDataId(o))){var u=e.extend({showcheck:"false",haschild:"false",complete:"false",expand:"false",groupid:null,href:null,checked:"false",disabled:"false"},s?a:{id:a,text:n,value:i,showcheck:d?"true":"false",haschild:r?"true":"false"});if(u.dataid=c?c.dataid+"●"+u.id:u.id,c){if(c.childNodes||(c.childNodes={}),"true"!=c.haschild&&(c.haschild="true"),"undefined"!=typeof c.childNodes[u.id])return;c.childNodes[u.id]=u}else{if(l.data||(l.data={}),"undefined"!=typeof l.data[u.id])return;l.data[u.id]=u}var p=l._buildNode(u);if(c){var h=e("#"+l.id+"○"+o),f=h.children("ul:first"),g=""+h.attr("className");if((" "+g+" ").indexOf(" leaf ")>-1&&(g=e.trim((" "+g+" ").replace(/ leaf /g," unfold ")),h.attr("className",g)),f&&f.length)switch(t){case"prepend":f.prepend(p);break;case"append":default:var v=f.children("li[class!=leaf]:last");r&&v&&v.length?v.after(p):f.append(p)}else h.prepend("<ul>\n"+p+"</ul>\n");h=f=null}else{var f=e(l.el).children("ul:first");if(f&&f.length)switch(t){case"prepend":f.prepend(p);break;case"append":default:var v=f.children("li[class!=leaf]:last");r&&v&&v.length?v.after(p):f.append(p)}else e(l.el).html("<ul>\n"+p+"</ul>\n");f=null}p=null}}},append:function(e,t,a,n,i,d){var o=this;o.insert("append",e,t,a,n,i,d)},prepend:function(e,t,a,n,i,d){var o=this;o.insert("prepend",e,t,a,n,i,d)},remove:function(t,a){var n=this;if(t&&e.isString(t)){var i=n._getNodeDataByDataId(t);if(i){var d=i.id,o=n._getParentNodeDataByDataId(t);if(o){if(delete o.childNodes[d],e.isEmptyObject(o.childNodes)&&!a){o.haschild="false";var r=e("#"+n.id+"○"+o.dataid),l=r.children("ul:first");"leaf"!=r.attr("className")&&r.attr("className","leaf"),r=l=null}}else delete n.data[d];e("#"+n.id+"○"+t).remove(),i=null}}},empty:function(){var t=this;if(t.data){e(t.el).empty();var a=function(e){for(var t in e)"childNodes"==t&&a(e[t]),delete e[t]};a(t.data),delete t.data,t.data=null,t.lastActiveTapNodeId=null,t.lastExpandNodeId=null,t.lastCheckedNodeId=null,e.browser.msie&&CollectGarbage()}},draw:function(){var t=this;if(t.data){var a=[];a.push("<ul>\n");var n=[];for(var i in t.data)t.data[i]&&e.isObject(t.data[i])&&n.push([i,t.data[i].order]);n.sort(function(e,t){return parseInt(e[1])-parseInt(t[1])});for(var d=0;d<n.length;d++)a.push(t._buildNode(t.data[n[d][0]])),n.splice(d--,1);n=null,a.push("</ul>\n"),e(t.el).html(a.join(""))}},expand:function(t){var n=this,i=n._getNodeDataByNodeId(t);if(i){var d="true"==""+i.haschild,o="true"==""+i.complete;if(!1!==e.event.trigger("expandAction",i,n.el)){if(d&&!o){if(n.isAsync&&n.asyncLoading)return void MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.node-loading-uncompleted"));if(n.isAsync&&!i.childNodes){var r=n._buildParams();r+="&Tree_Parent_NodeID="+encodeURIComponent(i.id),r+="&Tree_Parent_DataID="+encodeURIComponent(i.dataid),r+="&Tree_Parent_GroupID="+(null!=i.groupid&&void 0!=i.groupid?encodeURIComponent(i.groupid):""),r+="&Tree_Parent_isChecked="+encodeURIComponent(i.checked),n.asyncLoading=!0;var l=function(a){n.asyncLoading=!1,e("#"+t+"_loading").remove();var d=a.context;return"0"!=d.x_resultcode?(n.queue.length=[],void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),d.x_resultinfo)):a.data&&e.isObject(a.data)?(i.childNodes=a.data,void n.expand(t)):void 0};return e("#"+t+" div[class=text]").prepend('<span id="'+t+'_loading" class="e_ico-loading"></span>'),void(n.clazz&&n.method?e.httphandler.post(n.clazz,n.method,r,l,null,{dataType:"json",simple:!0}):(n.listener||n.componentId)&&e.ajax.post(n.page?n.page:null,n.listener,r,n.componentId?n.componentId:null,l,null,{dataType:"json",simple:!0}))}var s=[],c=i.childNodes;if(c&&e.isObject(c)){var u=[];for(var p in c)c[p]&&e.isObject(c[p])&&u.push([p,c[p].order]);u.sort(function(e,t){return parseInt(e[1])-parseInt(t[1])});for(var h=0;h<u.length;h++)s.push(n._buildNode(c[u[h][0]])),u.splice(h--,1);u=null,e("#"+t+" ul:first").html(s.join("")),s=null,i.complete="true"}else!1!==n.isNodataWarning&&MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.childnode-no-data"))}if(d){var f=a.getElementById(t);if(f&&1==f.nodeType){var g=f.className?f.className:"";(" "+g+" ").indexOf(" leaf ")<0&&(f.className=e.trim((" "+g+" ").replace(/ fold /gi," "))+" unfold")}f=null,n._autoRefreshScroller()}n.queue.splice(e.inArray(t,n.queue),1)}}},expandQueue:function(){var e=this;e.queue.length?(e.asyncLoading||e.expand(e.queue[0]),e.timer=setTimeout("window['"+e.id+"'].expandQueue();",500)):e.timer&&clearTimeout(e.timer)},expandByPath:function(t,a,n){var i=this;if(e.isFunction(a)&&(n=a,a=null),!t||!e.isString(t))return void MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.invalid-expandpath"));a&&e.isString(a)||(a="-"),e.isFunction(n)&&(i.expandByPathCallback=n);for(var d,o=t.split(a),r=[],l=0;l<o.length;l++)r.push(o[l]),d=i.id+"○"+r.join("●"),l==o.length-1&&(i.lastExpandNodeId=d),i.isAsync?i.queue.push(d):i.expand(d);o=r=null,i.isAsync&&i.expandQueue()},collapse:function(t){var n=this,i=a.getElementById(t);if(i&&1==i.nodeType){var d=i.className?i.className:"";(" "+d+" ").indexOf(" leaf ")<0&&(i.className=e.trim((" "+d+" ").replace(/ unfold /gi," "))+" fold")}i=null,n._autoRefreshScroller()},destroy:function(){var t=this;if(t.data)for(var a in t.data)delete t.data[a];if(t.data=null,e.isObject(t.params)){for(var i in t.params)delete t.params[i];t.params=null}for(var d=0;d<t.queue.length;d++)n.call(t.queue,d--,1);t.queue=null,t.el=null},_init:function(){var t=this;this.queue=[],e(t.el).tap(function(a){a.originalEvent&&(a=e.event.fix(a.originalEvent));var n=a.target;if(n&&1!=!n.nodeType){var i,d,o,r,l,s=n.className?n.className:"";if(e.nodeName(n,"input")&&e.attr(n,"type")==t.checkBoxType&&(i=n.parentNode)&&(i=i.parentNode)&&1==i.nodeType&&e.nodeName(i,"li")&&(o=e.attr(i,"id"))){if(t._activeNode(o),!1===e.event.trigger("checkBoxAction",t._getNodeDataByNodeId(o),t.el))return n.checked=!n.checked,void(i=d=s=null);t._checkNode(o,n.checked)}else if(e.nodeName(n,"div")&&(i=n.parentNode)&&1==i.nodeType&&e.nodeName(i,"li")&&(o=e.attr(i,"id")))if(l=i.className?i.className:"",r=(" "+l+" ").indexOf(" unfold ")>-1,t._activeNode(o),(" "+s+" ").indexOf(" text ")>-1){if(!1===e.event.trigger("textAction",t._getNodeDataByNodeId(o),t.el))return void(i=d=s=l=null);var c=!1;if(t.isShowCheckBox){for(var u=0,p=n.previousSibling,h=!1;u<3&&p;){if(1==p.nodeType&&e.nodeName(p,"div")&&(" "+p.className+" ").indexOf(" checkbox ")>-1){h=!0;break}p=p.previousSibling,u++}if(!0===h){var f=p.getElementsByTagName("input")[0];if(f&&1==f.nodeType&&e.attr(f,"type")==t.checkBoxType){if(c=!0,!1===e.event.trigger("checkBoxAction",t._getNodeDataByNodeId(o),t.el))return void(i=d=s=l=null);t._checkNode(o,!f.checked,!1)}}}c||t._triggerNode(o,r)}else(" "+s+" ").indexOf(" ico ")>-1&&t._triggerNode(o,r);i=d=s=l=null}})},_autoRefreshScroller:function(){for(var n,i=this,d=i.el.parentNode,o=0;o<50&&d&&d.nodeType&&d!=a.body;)1==d.nodeType&&"scroller"==e.attr(d,"x-wade-uicomponent")&&(n=e.attr(d,"id"))&&t[n]&&t[n]instanceof e.Scroller&&t[n].refresh(),d=d.parentNode,o++;d=null},_getDataIdByNodeId:function(t){if(t&&e.isString(t)){var a=t.lastIndexOf("○");return t.substring(a+1,t.length)}},_getNodeDataByDataId:function(t){var a=this;if(t&&e.isString(t)&&a.data&&e.isObject(a.data)){var n,i=t.split("●");if(i&&i.length)for(var n,d,o=0;o<i.length&&(0==o?n=a.data[i[o]]:n&&(d=n.childNodes,d&&e.isObject(d)&&(n=d[i[o]])),n);o++);return i=null,n}},_getParentNodeDataByDataId:function(t){var a=this;if(t&&e.isString(t)){var n,i=t.split("●");return i&&i.length>=2&&(i.splice(i.length-1,1),n=a._getNodeDataByDataId(i.join("●"))),i=null,n}},_getNodeDataByNodeId:function(t){var a=this;if(t&&e.isString(t)){var n=t.lastIndexOf("○"),i=t.substring(n+1,t.length);return a._getNodeDataByDataId(i)}},_buildParams:function(){var t=this,a=[];if(a.push("Tree_ID="+encodeURIComponent(t.id)),a.push("Tree_IsShowCheckBox="+t.isShowCheckBox),a.push("Tree_IsSearch="+t.isSearch),a.push("Tree_IsFolder="+t.isFolder),a.push("Tree_IsAsync="+t.isAsync),t.checkBoxName&&a.push("Tree_CheckBoxName="+encodeURIComponent(t.checkBoxName)),t.checkBoxType&&a.push("Tree_CheckBoxType="+encodeURIComponent(t.checkBoxType)),t.iconDir&&a.push("Tree_IconDir="+encodeURIComponent(t.iconDir)),!e.isEmptyObject(t.params))for(var n in t.params)a.push(encodeURIComponent(n)+"="+encodeURIComponent(t.params[n]));return a.join("&")},_buildNode:function(t){var a=this;if(t&&e.isObject(t)){var n=[],i=t.dataid,d=a.id+"○"+i,o="true"==""+t.haschild,r=("true"==""+t.complete,t.href,o?"fold":"leaf");return n.push('<li id="'+d+'" class="'+r+'">\n'),n.push('<div class="ico"></div>\n'),"true"==t.showcheck&&(n.push('<div class="checkbox">'),n.push('<input name="'+a.checkBoxName+'" type="'+("radio"==a.checkBoxType?"radio":"checkbox")+'" value="'+t.value+'" '+("true"==""+t.checked?"checked":"")+" "+("true"==""+t.disabled?"disabled":"")+" />"),n.push("</div>\n")),n.push('<div class="text" title="'+t.text+'" >'+t.text+"</div>\n"),o&&n.push("<ul></ul>"),n.push("</li>\n"),n.join("")}},_triggerNode:function(e,t){var a=this;e&&(t?a.collapse(e):a.expand(e))},_checkNode:function(t,a,n){var i=this;if(i.isShowCheckBox){var d=i._getNodeDataByNodeId(t);if(d){if("radio"==i.checkBoxType)d.checked="true",i.lastCheckedNodeId&&t!=i.lastCheckedNodeId&&(d=i._getNodeDataByNodeId(i.lastCheckedNodeId))&&(d.checked="false",0==n&&e("#"+i.lastCheckedNodeId+" input[type=radio]:first").attr("checked",!!a)),0==n&&t!=i.lastCheckedNodeId&&e("#"+t+" input[type=radio]:first").attr("checked",!!a);else if("checkbox"==i.checkBoxType&&(d.checked=a?"true":"false",0==n&&e("#"+t+" input[type=checkbox]:first").attr("checked",!!a),"true"==d.haschild)){var o=d.childNodes;if(o&&e.isObject(o)){var r;for(var l in o)r=o[l],e.isObject(r)&&i._checkNode(i.id+"○"+r.dataid,a,!1)}}i.lastCheckedNodeId=t}}},_activeNode:function(t){var n,i,d=this;t&&e.isString(t)&&t!=d.lastActiveTapNodeId&&(n=a.getElementById(t),i=d.lastActiveTapNodeId?a.getElementById(d.lastActiveTapNodeId):null,i&&1==i.nodeType&&(i.className=e.trim((" "+i.className+" ").replace(/ on /gi," "))),n&&1==n.nodeType&&(n.className=e.trim((n.className?n.className:"")+" on"),d.lastActiveTapNodeId=t)),n=i=null}}),t.Tree=e.Tree=i}}(Wade,window,document);