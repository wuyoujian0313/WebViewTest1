/*!
 * simple export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,i){"use strict";if(e&&"undefined"==typeof e.Export){var r=(Array.prototype.splice,3e3),n=function(t,r){var n=this;n.el=t&&1==t.nodeType?t:i.getElementById(t),n.el&&n.el.nodeType&&(n.id=e.attr(n.el,"id"))&&(r&&e.isObject(r)&&e.extend(n,r),e.attr(n.el,"x-wade-uicomponent")||e.attr(n.el,"x-wade-uicomponent","simpleexport"),n._init(),n.constructor.call(n))};n.prototype=e.extend(new e.UIComponent,{setParams:function(t){var i=this;t&&e.isString(t)&&(i.params=t)},buildParams:function(t){var i=this,r=[];return r.push("rpcSessionId="+i.rpcSessionId),r.push("pushMode="+i.pushMode),r.push("config="+(i.configFile?i.configFile:"")),r.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),r.push("filePath="+(i.filePath?i.filePath:"export")),r.push("fileId="+(i.file?i.file.fileId:"")),r.push("fileType="+(i.fileType?i.fileType:"")),r.push("model="+(i.model?i.model:"")),r.push("posX="+(i.posX?i.posX:"")),r.push("posY="+(i.posY?i.posY:"")),r.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),r.push("taskId="+(i.taskId?i.taskId:"")),r.push("serviceName="+(i.taskId?i.taskId:"")),r.push("listenerMethod="+(t?t:"")),r.push("fileName="+encodeURIComponent(i.fullFileName)),e.ajax.buildSubmitData(i.cond,r.join("&")+(i.params&&e.isString(i.params)?"&"+i.params:""))},tip:function(e,t){var i=this;void 0!=e&&(i.el.value=e),void 0!=t&&(i.el.className="e_left "+t)},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(t){var i=this;i.disabled=!!t;var r=i.span.className?i.span.className:"";i.disabled?((" "+r+" ").indexOf(" e_dis ")<0&&(i.span.className=e.trim(r+" e_dis")),i.el.disabled=!0):(r=e.trim((" "+r+" ").replace(/ e_dis /gi," ")),i.span.className=r,i.el.disabled=!1)},destroy:function(){var e=this;e.rpc&&(e.rpc.destroy(),e.rpc=null),e.span=null,e.btnReset=null,e.btnDownload=null,e.btnExport=null,e.progEl=null,e.progBarEl=null,e.el=null},_init:function(){var i=this;i.span=e(i.el).parent("span.e_mix:first"),i.btnReset=e(i.span).find("span.e_ico-reset:first").parent("button")[0],i.btnDownload=e(i.span).children("span.e_ico-download:first")[0],i.btnExport=e(i.span).find("span.e_ico-export:first").parent("button")[0],i.progEl=e(i.span).children("span.e_mixProgress:first")[0],i.progBarEl=e(i.progEl).children("span.e_mixBar:first")[0],e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleexport.tip.export-file-download")),i.fileTypes&&(i.fileTypes=e.FileTransfer.fileTypes(i.fileTypes)),i.rpcSessionId=e.expando+"_"+e.rand(1e6)+"_"+i.id,e(i.btnReset).tap(function(){i.disabaled||!0===i.exporting||(e.attr(i.el,"readOnly",null),i.btnReset.style.display="none",i.btnDownload.style.display="none",i.btnExport.style.display="",i.progBarEl.style.width="0%",i.el.value=i.fileName?i.fileName:"",i.tip(i.defaultTip,"e_black-light"))}),e(i.btnDownload).tap(function(){i.disabaled||!0===i.exporting||i.downUrl&&t.open(i.downUrl+"&_="+Math.random(),"_new_download_win","height=40,width=100,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}),e(i.btnExport).tap(function(){if(!i.disabaled&&!0!==i.exporting){var n=i.fileName=i.el.value;if(n&&e.trim(n)){var l=e("#"+i.id+"_filetype_sel").val();if(i.fileTypes&&e.inArray(l,i.fileTypes)<0)return void i.tip(e.lang.get("ui.component.simpleexport.tip.invalid-filename"),"e_red");i.fullFileName=n+l,!1!==e.event.trigger("beforeAction",null,i.el)&&(i.fileSerializeId=null,e.attr(i.el,"readOnly",!0),i.tip(e.lang.get("ui.component.simpleexport.tip.begin-export",n)),e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(l){if(i.fileSerializeId=l.fileSerializeId,i.messageServer=l.messageServer,i.messageServerType=l.messageServerType?l.messageServerType:null,!0===i.exporting)if("10"==l.progress)i.tip(e.lang.get("ui.component.simpleexport.tip.export-started"));else{if(!i.fileSerializeId&&"error"==l.status)return i.exporting=!1,i.progBarEl.style.width="0%",void i.tip(l.hint,"e_red");i.progBarEl.style.width=l.progress+"%",i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",l.progress,n))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new e.RPC({address:i.messageServer,type:i.messageServerType,session:"&sessionId="+i.rpcSessionId,message:function(t){if(t&&e.isObject(t))if("prog"!=t.STATUS){if(i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==t.STATUS){i.progBarEl.style.width="100%";var r=i.downUrl=t.DOWNLOAD_URL;r&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==t.STATUS&&(i.progBarEl.style.width="0%",i.tip(t.ERROR_INFO,"e_red"));e.event.trigger("afterAction",t.STATUS,i.el)}else if(t.PROG){var n=(""+t.PROG).indexOf("%")>-1?t.PROG:t.PROG+"%";i.progBarEl.style.width=n,i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",n,i.fileName))}}}),i.rpc.open()):i.timer=t.setInterval(function(){return i.fileSerializeId?void e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(r){if(!r||!e.isObject(r))return void t.clearInterval(i.timer);if("100"==r.progress||"error"==r.status){if(t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==r.status){i.progBarEl.style.width="100%";var n=i.downUrl=r.downloadUrl;n&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==r.status&&(i.progBarEl.style.width="0%",i.tip(r.hint,"e_red"));e.event.trigger("afterAction",r.status,i.el)}},error:function(r,n,l){t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",n),"e_red")}}):void t.clearInterval(i.timer)},r)},error:function(t,r,n){i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",r),"e_red")}}),i.exporting=!0)}}})}}),t.SimpleExport=e.SimpleExport=n}}(window.Wade,window,document);